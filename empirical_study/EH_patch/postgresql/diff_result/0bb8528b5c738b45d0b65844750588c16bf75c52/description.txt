{
    "author": "Tom Lane",
    "description": "Fix postgres_fdw to return the right ctid value in EvalPlanQual cases.\n\nIf a postgres_fdw foreign table is a non-locked source relation in an\nUPDATE, DELETE, or SELECT FOR UPDATE/SHARE, and the query selects its\nctid column, the wrong value would be returned if an EvalPlanQual\nrecheck occurred.  This happened because the foreign table's result row\nwas copied via the ROW_MARK_COPY code path, and EvalPlanQualFetchRowMarks\njust unconditionally set the reconstructed tuple's t_self to \"invalid\".\n\nTo fix that, we can have EvalPlanQualFetchRowMarks copy the composite\ndatum's t_ctid field, and be sure to initialize that along with t_self\nwhen postgres_fdw constructs a tuple to return.\n\nIf we just did that much then EvalPlanQualFetchRowMarks would start\nreturning \"(0,0)\" as ctid for all other ROW_MARK_COPY cases, which perhaps\ndoes not matter much, but then again maybe it might.  The cause of that is\nthat heap_form_tuple, which is the ultimate source of all composite datums,\nsimply leaves t_ctid as zeroes in newly constructed tuples.  That seems\nlike a bad idea on general principles: a field that's really not been\ninitialized shouldn't appear to have a valid value.  So let's eat the\ntrivial additional overhead of doing \"ItemPointerSetInvalid(&(td->t_ctid))\"\nin heap_form_tuple.\n\nThis closes out our handling of Etsuro Fujita's report that tableoid and\nctid weren't correctly set in postgres_fdw EvalPlanQual cases.  Along the\nway we did a great deal of work to improve FDWs' ability to control row\nlocking behavior; which was not wasted effort by any means, but it didn't\nend up being a fix for this problem because that feature would be too\nexpensive for postgres_fdw to use all the time.\n\nAlthough the fix for the tableoid misbehavior was back-patched, I'm\nhesitant to do so here; it seems far less likely that people would care\nabout remote ctid than tableoid, and even such a minor behavioral change\nas this in heap_form_tuple is perhaps best not back-patched.  So commit\nto HEAD only, at least for the moment.\n\nEtsuro Fujita, with some adjustments by me\n",
    "summary": "Fix postgres_fdw to return the right ctid value in EvalPlanQual cases.",
    "date": "2015-05-13 14:05:29",
    "parent_hash": "3f2cec797ecceb7467e365410506c0817f9d0163",
    "hash": "0bb8528b5c738b45d0b65844750588c16bf75c52"
}